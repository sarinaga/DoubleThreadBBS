
                          マルチスレッド掲示板 インストール方法

                                                      2004/10/18 さゆりん先生 

☆必要な環境

・Perl5.004以上がインストールされたUNIXまたはWindows
・Apache 1.??以降 [UNIXではSuExecを利用することが前提]

動作確認はWindows2000(or XP) & Perl5.8.1 & Apache2.0とFreeBSD??? & Apache????
(さくらインターネットの旧サーバー)で行っています。


☆利用するモジュール

以下のモジュールのインストールが必要です。

  ・Digest-MD5: http://search.cpan.org/~gaas/Digest-MD5-2.33/
  ・Digest-SHA1: http://search.cpan.org/~gaas/Digest-SHA1-2.10/
  ・Crypt-PasswdMD5: http://search.cpan.org/~luismunoz/Crypt-PasswdMD5-1.3/
  ・CGI: http://search.cpan.org/~lds/CGI.pm-3.05/


加えて以下のモジュールをインストールしておくとよりよいでしょう。

  ・Encode: http://search.cpan.org/~dankogai/Encode-2.03/
  ・Time::HiRes: http://search.cpan.org/~jhi/Time-HiRes-1.65/

Encodeモジュールに関しては、ない場合は変わりにJcode.plを
利用するのでインストールする必要はありません。

Time::HiResモジュールはインストールするとファイルロック処理の
パフォーマンス向上が期待できます。

たいていのシステムではCrypt-PasswdMD5のみをインストールすれば
いいでしょう。

筆者の環境(さくらインターネット旧サーバーPerl5.004)ではCrypt-PasswdMD5,
Digest-SHA1, Digest-MD5のインストールが必要でした。

モジュールのインストール方法はラクダ本などを参照してください。
Windowsシステムへのインストールはさりながのプログラミングおもちゃ箱
()にも掲載しているのでご参照ください。



☆掲示板設置方法

設置手順は以下のように行います。

   0. ファイルの設置・転送
   1. ".htaccess"       の設定 (たいていの場合は設定の必要なし)
   2. "bbs.conf"        の設定
   3. "threadlist.info" の設定
   4. "bbs.css"         の設定 (特に必要がある場合のみ)
   5. "admin.info"      の設定 (特に必要がある場合のみ)
   6. *.cgiファイルの1行目書き換え
   7. ファイルパーミッションの設定
   8. (init.htmlから)初期化処理
   9. 管理者パスワードの変更

以下、それぞれについて解説していきます。


0. ファイルの設置・転送

まず、tarballを展開すると以下のようなファイルが作成されます。
これらのファイルをCGIを動作させるディレクトリに移動します。
各ファイルの役割を記述しましたので参考にしてください。

  .htaccess   apacheの設定ファイル.

  admin.cgi   管理者機能を提供するCGIプログラム.
  read.cgi    掲示板表示機能を提供するCGIプログラム.
  write.cgi   投稿処理機能を提供するCGIプログラム.

  file.pl     主にファイル入出力関連の処理を行うPerlスクリプト.
  write.pl    共通変数保存用.
  html.pl     主にHTML出力関連の処理を行うPerlスクリプト.
  std.pl      汎用的な処理を行うPerlスクリプト.
  jcode.pl    文字コード変換を行うPerlスクリプト. Encode.pmが利用できないとき
              代わりに利用される.

  bbs.conf        マルチスレッド掲示板の設定ファイル.
  admin.info      admin.htmlの元となるファイル.
  threadlist.info index.htmlの元となるファイル.

  bbs.html    マルチスレッド掲示板の利用方法が書かれたHTMLファイル.
  bbs.css     マルチスレッド掲示板のスタイルシート(CSS).
  bbs.js      マルチスレッド掲示板が利用するJavascript.
  init.html   マルチスレッド掲示板を最初に利用するとき、このファイルから
              初期化処理を呼び出す.

  admin.html  (展開した段階では内容はありません) 管理者メニューのHTML.
  index.html  (展開した段階では内容はありません) 掲示板のトップページ.

  icon_mail.gif Email画像
  icon_web.gif  Webpage画像

  readme.txt  このファイル:-).
  faq.txt     FAQ:-).


1. ".htaccess" の設定

言わずと知れたapacheの制御用設定ファイルです。
大抵の場合はtarballを展開したままの内容でで大丈夫です。
展開された .htaccess で行っている設定は以下のとおりです。

  ・CGIの実行を許可する.
  ・ディレクトリインデックスを表示しない.
  ・ファイル名が指定されなかったときはindex.htmlを表示する.

  ・HTMLファイルの送信時、httpリクエストヘッダのAcceptにapplication/xml
    またはapplication/xhtml+xmlがあるときはそれをContent-Typeとして返す.
    そうでないときはContent-Typeにtext/html; charset=euc-jpを返す.

  ・JavaScriptファイルのContent-Typeをtext/html; charset=euc-jpで返す.
  ・拡張子が .pl .info .conf であるファイルのアクセスを禁止する.
  ・拡張子が .log であるファイルのアクセスを禁止する.
  ・bbs.html と admin.html のローカルキャッシュを無効にする.

必要があれば、お使いの環境に合わせて変更します。
アクセス制限などがあるときもここから行います。


2. "bbs.conf" の設定

このファイルで掲示板の基本的な設定を行います。
記述方法や内容はbbs.confに詳しく書かれているのでそれを参照してください。


3. "threadlist.info" の設定

掲示板のトップページである bbs.html の説明文のところを差し替えることが
できます。説明は threadlist.info に書かれているので、そちらを参照して
ください。


4. "bbs.css" の設定 (特に必要がある場合のみ)

掲示板のデザインが気に入らないときは、このCSSファイルを書き換えて
デザインを変更することができます。

CGIプログラムがどこでどのようなid class属性を出力しているかについては,
実際に出力されるXHTMLを解析してくださいとしか言いようがありません^^;。


5. "admin.info" の設定 (特に必要がある場合のみ)

admin.htmlのデザインを変更することができますが、基本的に書き換えては
いけません。$?????? の部分が変数展開されますので、書き換えるときは
その部分に支障がないように書き換えることが必要になります。


6. *.cgiファイルの1行目書き換え

1行目の #!/usr/bin/perl をPerlへのパスに書き換えます.
どのように書き換えるかはシステム管理者にお問い合わせください。


7. ファイルパーミッションの設定

各ファイルのパーミッションは以下のように設定してください。
スラッシュ(/)以降はSuEXECを利用しないときの物です。

   .htaccess    644/644   (httpdが読める権限)
   *.cgi        700/777   (自分が実行できる権限/httpdが実行できる権限)
   *.html       644/644   (httpdが読める権限)
   *.css        644/644   (httpdが読める権限)
   bbs.conf     600/644   (自分が読める権限/httpdが読める権限)
   *.pl         600/644   (自分が読める権限/httpdが読める権限)
   *.info       600/644   (自分が読める権限/httpdが読める権限)

ここに該当しないファイルのアクセス権に関しては適当でかまいません。
(まあ、readme.txtとかですから...)

ちなみに、SuExecを利用しない場合は wwwやnobodyがファイル所有権を
持つことになってしまいよくありません。また、bbs.confが外から
読めることにもなってしまいます。


8. (init.htmlから)初期化処理

Webブラウザからinit.htmlを開きます。そうしますと、初期化を促すメッセージが
表示されますので、各種設定を正しく行ったことを確認してから「初期化する」
ボタンを押下してください。

設定が正しければ、正常に終了した旨のメッセージが表示されます。
失敗したときはエラーメッセージが表示されます。大抵の場合は設定ミス
ですのでもう一度1.から6.までの設定を見直してみてください。

それでも動かなかったときは......サポートスレで質問してください。


9. 管理者パスワードの変更

パスワードファイルは bbs.conf で指定した SECRET_LOGディレクトリ配下に passwd
というファイル名で作成されます. 初期ユーザ/パスワードは「admin/admin」になって
いるので、そのままだと知らない第三者に掲示板の管理モードから操作が行えてしまい
ます。パスワードを変更してください。

変更方法は2つあります。

  ・htpasswdコマンドを利用する (passwdファイルはhtpasswd形式です)
  ・管理モードのpasswordコマンドを利用する

それぞれ man htpasswd と admin.html の説明を参考にしてください。

なお、管理ユーザを新たに追加するには、htpasswdコマンドでユーザを
追加しなくてはなりません。



☆設置後の作業

何はともあれ、bbs.htmlを開き、正常に動くことを確認してください。
エラーが発生したときは、error.logにperlのエラーメッセージが出力されるので
それを参考にします。httpd - apacheのログファイルも参考になるでしょう。

正常に動くことを確認したら、bbs.confなどの微調整などを適時行えば
いいでしょう。



☆最後に

まだこのスクリプトはβであるため、マニュアル・プログラムともに間違い等が
あると思われましす。そのときは、容赦なくサポートBBSの方に書き込んでください。

